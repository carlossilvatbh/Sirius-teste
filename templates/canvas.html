{% extends 'base.html' %}
{% load static %}

{% block title %}SIRIUS Canvas - Legal Structure Designer{% endblock %}

{% block content %}
<div id="app" class="min-h-screen bg-gray-50">
    <!-- Main Canvas Interface -->
    <div class="flex h-screen">
        <!-- Left Sidebar - Structure Library -->
        <div class="w-80 bg-white shadow-lg border-r border-gray-200 overflow-y-auto">
            <!-- Sidebar Header -->
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-lg font-bold text-gray-900 mb-2">Structure Library</h2>
                <p class="text-sm text-gray-600">Drag structures to the canvas</p>
            </div>
            
            <!-- Search and Filters -->
            <div class="p-4 border-b border-gray-200">
                <div class="relative mb-4">
                    <input 
                        type="text" 
                        v-model="searchQuery"
                        placeholder="Search structures..."
                        class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sirius-blue focus:border-transparent"
                    >
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                </div>
                
                <select 
                    v-model="selectedCategory"
                    class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sirius-blue focus:border-transparent"
                >
                    <option value="">All Categories</option>
                    <option value="BDAO_SAC">Bahamas DAO SAC</option>
                    <option value="WYOMING_DAO_LLC">Wyoming DAO LLC</option>
                    <option value="BTS_VAULT">BTS Vault</option>
                    <option value="WYOMING_FOUNDATION">Wyoming Foundation</option>
                    <option value="WYOMING_CORP">Wyoming Corporation</option>
                    <option value="NATIONALIZATION">Nationalization</option>
                    <option value="FUND_TOKEN">Fund Token</option>
                </select>
            </div>
            
            <!-- Structure Cards -->
            <div class="p-4">
                <div 
                    v-for="estrutura in filteredEstruturas" 
                    :key="estrutura.id"
                    class="structure-card"
                    draggable="true"
                    @dragstart="iniciarDrag(estrutura, $event)"
                    @click="selecionarEstrutura(estrutura)"
                    :class="{ 'ring-2 ring-sirius-blue': estruturaSelecionada?.id === estrutura.id }"
                >
                    <div class="complexity-indicator" :class="`complexity-${estrutura.complexidade}`"></div>
                    <div class="structure-type">{{ estrutura.tipo_display }}</div>
                    <div class="structure-name">{{ estrutura.nome }}</div>
                    <div class="structure-cost">{{ formatCurrency(estrutura.custo_base) }}</div>
                    <div class="text-xs text-gray-500 mt-2">
                        <i class="fas fa-clock mr-1"></i>{{ estrutura.tempo_implementacao }} days
                    </div>
                </div>
            </div>
            
            <!-- Templates Section -->
            <div class="p-4 border-t border-gray-200">
                <h3 class="text-md font-semibold text-gray-900 mb-3">Quick Templates</h3>
                <div 
                    v-for="template in templates" 
                    :key="template.id"
                    class="template-card cursor-pointer"
                    @click="carregarTemplate(template.id)"
                >
                    <div class="template-category">{{ template.categoria_display }}</div>
                    <div class="template-name">{{ template.nome }}</div>
                    <div class="template-description">{{ template.descricao }}</div>
                    <div class="template-stats">
                        <span>{{ formatCurrency(template.custo_total) }}</span>
                        <span>{{ template.uso_count }} uses</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Canvas Area -->
        <div class="flex-1 flex flex-col">
            <!-- Canvas Toolbar -->
            <div class="bg-white border-b border-gray-200 p-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <button 
                            @click="limparCanvas"
                            class="btn-secondary"
                            :disabled="elementos.length === 0"
                        >
                            <i class="fas fa-trash"></i>
                            Clear Canvas
                        </button>
                        
                        <button 
                            @click="salvarTemplate"
                            class="btn-primary"
                            :disabled="elementos.length === 0"
                        >
                            <i class="fas fa-save"></i>
                            Save Template
                        </button>
                        
                        <button 
                            @click="gerarPDF"
                            class="btn-primary"
                            :disabled="elementos.length === 0"
                        >
                            <i class="fas fa-file-pdf"></i>
                            Generate PDF
                        </button>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <!-- Pricing Scenario Selector -->
                        <select 
                            v-model="cenarioPrecificacao"
                            class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sirius-blue"
                        >
                            <option value="basico">Basic Scenario</option>
                            <option value="completo">Complete Scenario</option>
                            <option value="premium">Premium Scenario</option>
                        </select>
                        
                        <!-- Total Cost Display -->
                        <div class="bg-green-50 border border-green-200 rounded-lg px-4 py-2">
                            <div class="text-sm text-green-600 font-medium">Total Cost</div>
                            <div class="text-lg font-bold text-green-800">
                                {{ formatCurrency(custoTotalComCenario) }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Canvas Container -->
            <div class="flex-1 relative">
                <div 
                    ref="canvasContainer"
                    class="canvas-container w-full h-full"
                    @dragover="permitirDrop"
                    @drop="handleDrop"
                >
                    <!-- Vue Flow Canvas will be mounted here -->
                    <div id="vue-flow-container" class="w-full h-full"></div>
                    
                    <!-- Canvas Elements (if Vue Flow is not available) -->
                    <div v-if="!vueFlowAvailable" class="relative w-full h-full p-8">
                        <div 
                            v-for="elemento in elementos" 
                            :key="elemento.id"
                            class="absolute bg-white rounded-lg shadow-lg border-2 border-gray-200 p-4 cursor-move"
                            :style="{ 
                                left: elemento.position.x + 'px', 
                                top: elemento.position.y + 'px',
                                width: '200px'
                            }"
                            @mousedown="iniciarArrastar(elemento, $event)"
                            @click="selecionarElemento(elemento)"
                            :class="{ 'border-sirius-blue': elementoSelecionado?.id === elemento.id }"
                        >
                            <div class="text-sm font-semibold text-gray-900">{{ elemento.estrutura.nome }}</div>
                            <div class="text-xs text-gray-500 mt-1">{{ elemento.estrutura.tipo_display }}</div>
                            <div class="text-sm font-bold text-green-600 mt-2">
                                {{ formatCurrency(elemento.estrutura.custo_base) }}
                            </div>
                            <button 
                                @click.stop="removerElemento(elemento.id)"
                                class="absolute top-2 right-2 text-red-500 hover:text-red-700"
                            >
                                <i class="fas fa-times text-xs"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Empty State -->
                    <div v-if="elementos.length === 0" class="absolute inset-0 flex items-center justify-center">
                        <div class="text-center">
                            <i class="fas fa-network-wired text-6xl text-gray-300 mb-4"></i>
                            <h3 class="text-xl font-semibold text-gray-500 mb-2">Start Building Your Structure</h3>
                            <p class="text-gray-400">Drag legal structures from the sidebar to begin</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Sidebar - Information Panel -->
        <div class="w-96 bg-white shadow-lg border-l border-gray-200 overflow-y-auto">
            <!-- Structure Information -->
            <div v-if="estruturaSelecionada" class="p-6">
                <div class="info-panel">
                    <h3>
                        <i class="fas fa-info-circle text-sirius-blue"></i>
                        Structure Details
                    </h3>
                    
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-2">{{ estruturaSelecionada.nome }}</h4>
                            <p class="text-sm text-gray-600">{{ estruturaSelecionada.descricao }}</p>
                        </div>
                        
                        <div class="metric">
                            <span class="metric-label">Base Cost</span>
                            <span class="metric-value">{{ formatCurrency(estruturaSelecionada.custo_base) }}</span>
                        </div>
                        
                        <div class="metric">
                            <span class="metric-label">Annual Maintenance</span>
                            <span class="metric-value">{{ formatCurrency(estruturaSelecionada.custo_manutencao) }}</span>
                        </div>
                        
                        <div class="metric">
                            <span class="metric-label">Implementation Time</span>
                            <span class="metric-value">{{ estruturaSelecionada.tempo_implementacao }} days</span>
                        </div>
                        
                        <div class="metric">
                            <span class="metric-label">Complexity</span>
                            <span class="metric-value">{{ estruturaSelecionada.complexidade_display }}</span>
                        </div>
                        
                        <div class="metric">
                            <span class="metric-label">Confidentiality Level</span>
                            <span class="metric-value">{{ estruturaSelecionada.nivel_confidencialidade }}/5</span>
                        </div>
                        
                        <div class="metric">
                            <span class="metric-label">Asset Protection</span>
                            <span class="metric-value">{{ estruturaSelecionada.protecao_patrimonial }}/5</span>
                        </div>
                    </div>
                </div>
                
                <!-- Tax Information -->
                <div class="info-panel mt-6">
                    <h3>
                        <i class="fas fa-calculator text-sirius-blue"></i>
                        Tax Implications
                    </h3>
                    
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-2">United States</h4>
                            <p class="text-sm text-gray-600">{{ estruturaSelecionada.impacto_tributario_eua }}</p>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-2">Brazil</h4>
                            <p class="text-sm text-gray-600">{{ estruturaSelecionada.impacto_tributario_brasil }}</p>
                        </div>
                        
                        <div v-if="estruturaSelecionada.impacto_tributario_outros">
                            <h4 class="font-semibold text-gray-900 mb-2">Other Jurisdictions</h4>
                            <p class="text-sm text-gray-600">{{ estruturaSelecionada.impacto_tributario_outros }}</p>
                        </div>
                    </div>
                </div>
                
                <!-- Privacy Information -->
                <div class="info-panel mt-6">
                    <h3>
                        <i class="fas fa-shield-alt text-sirius-blue"></i>
                        Privacy & Protection
                    </h3>
                    
                    <p class="text-sm text-gray-600">{{ estruturaSelecionada.impacto_privacidade }}</p>
                </div>
            </div>
            
            <!-- Configuration Summary -->
            <div v-if="elementos.length > 0" class="p-6 border-t border-gray-200">
                <div class="info-panel">
                    <h3>
                        <i class="fas fa-chart-line text-sirius-blue"></i>
                        Configuration Summary
                    </h3>
                    
                    <div class="metric">
                        <span class="metric-label">Total Structures</span>
                        <span class="metric-value">{{ elementos.length }}</span>
                    </div>
                    
                    <div class="metric">
                        <span class="metric-label">Base Cost</span>
                        <span class="metric-value">{{ formatCurrency(custoTotal) }}</span>
                    </div>
                    
                    <div class="metric">
                        <span class="metric-label">{{ cenarioPrecificacao.charAt(0).toUpperCase() + cenarioPrecificacao.slice(1) }} Total</span>
                        <span class="metric-value">{{ formatCurrency(custoTotalComCenario) }}</span>
                    </div>
                    
                    <div class="metric">
                        <span class="metric-label">Max Implementation Time</span>
                        <span class="metric-value">{{ tempoTotal }} days</span>
                    </div>
                </div>
            </div>
            
            <!-- Validation Results -->
            <div v-if="validacao.erros.length > 0 || validacao.alertas.length > 0 || validacao.sugestoes.length > 0" 
                 class="p-6 border-t border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    <i class="fas fa-exclamation-triangle text-yellow-500"></i>
                    Validation Results
                </h3>
                
                <!-- Errors -->
                <div v-for="erro in validacao.erros" :key="erro.mensagem" class="validation-alert error">
                    <i class="fas fa-times-circle alert-icon"></i>
                    {{ erro.mensagem }}
                </div>
                
                <!-- Warnings -->
                <div v-for="alerta in validacao.alertas" :key="alerta.mensagem" class="validation-alert warning">
                    <i class="fas fa-exclamation-triangle alert-icon"></i>
                    {{ alerta.mensagem }}
                </div>
                
                <!-- Suggestions -->
                <div v-for="sugestao in validacao.sugestoes" :key="sugestao.mensagem" class="validation-alert info">
                    <i class="fas fa-lightbulb alert-icon"></i>
                    {{ sugestao.mensagem }}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/app.js' %}"></script>
{% endblock %}

