{% extends 'base.html' %}
{% load static %}

{% block title %}SIRIUS Canvas - Legal Structure Designer{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/canvas-clean.css' %}">
{% endblock %}

{% block content %}
<div class="app-container">
    <!-- Enhanced Header with mobile support -->
    <header class="app-header">
        <div class="header-brand">
            <button class="sidebar-toggle mobile-only" onclick="toggleMobileSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <div class="brand-logo">
                <i class="fas fa-layer-group"></i>
            </div>
            <div class="brand-text">
                <h1>SIRIUS Canvas</h1>
                <p class="desktop-only">Legal Structure Designer</p>
            </div>
        </div>
        
        <div class="header-actions">
            <button id="save-btn" class="btn btn-success btn-sm">
                <i class="fas fa-save"></i>
                <span class="desktop-only">Save</span>
            </button>
            <button id="pdf-btn" class="btn btn-secondary btn-sm">
                <i class="fas fa-file-pdf"></i>
                <span class="desktop-only">Export</span>
            </button>
            <button class="sidebar-toggle desktop-only" onclick="toggleSidebar()">
                <i class="fas fa-sidebar"></i>
            </button>
        </div>
    </header>

    <!-- Enhanced Main Content -->
    <main class="app-main">
        <!-- Mobile Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleMobileSidebar()"></div>
        
        <!-- Enhanced Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>
                    <i class="fas fa-layer-group"></i>
                    Structure Library
                </h2>
                <p>Drag structures to canvas to build your configuration</p>
                <button class="sidebar-toggle desktop-only" onclick="toggleSidebar()">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="sidebar-close mobile-only" onclick="toggleMobileSidebar()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="sidebar-content">
                <!-- Enhanced Search -->
                <div class="search-filters">
                    <div class="search-container">
                        <input 
                            type="text" 
                            id="search-structures" 
                            placeholder="Search structures..."
                            class="search-input"
                        >
                        <i class="fas fa-search search-icon"></i>
                        <button class="search-clear" id="search-clear" onclick="clearSearch()" style="display: none;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <!-- Filter Controls -->
                    <div class="filter-controls" id="filter-controls">
                        <button class="filter-tag active" data-filter="">All</button>
                        <button class="filter-tag" data-filter="BDAO_SAC">DAO</button>
                        <button class="filter-tag" data-filter="WYOMING_LLC">LLC</button>
                        <button class="filter-tag" data-filter="FOUNDATION">Foundation</button>
                        <button class="filter-tag" data-filter="CORP">Corporation</button>
                    </div>
                </div>
                
                <!-- Enhanced Structure List -->
                <div class="structures-list" id="structures-list">
                    <!-- Structure cards will be populated here -->
                </div>
                
                <!-- Empty State -->
                <div class="empty-state" id="structures-empty" style="display: none;">
                    <div class="icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <h3>No structures found</h3>
                    <p>Try adjusting your search or filter criteria</p>
                </div>
            </div>
        </aside>

        <!-- Enhanced Canvas Area -->
        <section class="canvas-area">
            <!-- Enhanced Toolbar -->
            <div class="canvas-toolbar">
                <div class="toolbar-section">
                    <div class="btn-group">
                        <button id="clear-canvas" class="btn btn-outline btn-sm">
                            <i class="fas fa-trash"></i>
                            <span class="desktop-only">Clear</span>
                        </button>
                        <button id="undo-btn" class="btn btn-outline btn-sm" disabled>
                            <i class="fas fa-undo"></i>
                        </button>
                        <button id="redo-btn" class="btn btn-outline btn-sm" disabled>
                            <i class="fas fa-redo"></i>
                        </button>
                    </div>
                    
                    <div class="btn-group">
                        <button id="zoom-out" class="btn btn-outline btn-sm">
                            <i class="fas fa-search-minus"></i>
                        </button>
                        <button id="zoom-reset" class="btn btn-outline btn-sm">
                            <span id="zoom-level">100%</span>
                        </button>
                        <button id="zoom-in" class="btn btn-outline btn-sm">
                            <i class="fas fa-search-plus"></i>
                        </button>
                    </div>
                    
                    <button id="connection-mode-btn" class="btn btn-ghost btn-sm">
                        <i class="fas fa-link"></i>
                        <span class="desktop-only">Connect</span>
                    </button>
                </div>
                
                <div class="toolbar-separator"></div>
                
                <div class="toolbar-section">
                    <div class="stats-display">
                        <div class="stats-item">
                            <span class="stats-label">Elements</span>
                            <span class="stats-value" id="element-count">0</span>
                        </div>
                        <div class="stats-item">
                            <span class="stats-label">Total Cost</span>
                            <span class="stats-value success" id="total-cost">$0</span>
                        </div>
                    </div>
                    
                    <select class="filter-select" id="pricing-scenario">
                        <option value="basico">Basic</option>
                        <option value="completo">Complete</option>
                        <option value="premium">Premium</option>
                    </select>
                </div>
            </div>
            
            <!-- Connection Mode Indicator -->
            <div class="connecting-mode-indicator" id="connection-indicator" style="display: none;">
                <i class="fas fa-link"></i>
                <span id="connection-status">Connection Mode Active</span>
            </div>
            
            <!-- Enhanced Canvas Container -->
            <div class="canvas-container" id="canvas-container">
                <div class="canvas-content">
                    <div class="canvas-grid" id="canvas-grid"></div>
                    <div class="canvas-elements" id="canvas-elements">
                        <!-- Canvas elements will be placed here -->
                    </div>
                    
                    <!-- Enhanced Empty State -->
                    <div class="canvas-empty" id="canvas-empty">
                        <div class="icon">
                            <i class="fas fa-network-wired"></i>
                        </div>
                        <h3>Start Building Your Structure</h3>
                        <p>Drag legal structures from the sidebar to begin designing your optimal configuration</p>
                        <button class="btn btn-primary mobile-only" onclick="toggleMobileSidebar()">
                            <i class="fas fa-plus"></i>
                            Add Structure
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="loading-overlay" style="display: none;">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <p>Loading SIRIUS...</p>
    </div>
</div>

<!-- Mobile Details Modal -->
<div id="mobile-details-modal" class="mobile-modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Structure Details</h3>
            <button class="modal-close" onclick="canvas.closeMobileDetails()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" id="mobile-details-body">
            <!-- Details will be populated here -->
        </div>
    </div>
</div>

<!-- Notifications Container -->
<div id="messages-container" class="messages-container"></div>

<!-- Pass Django data to JavaScript -->
<script>
    window.djangoData = {
        csrfToken: '{{ csrf_token }}',
        apiUrls: {
            estruturas: '{% url "estruturas:api_estruturas" %}',
            templates: '{% url "estruturas:api_templates" %}',
            calcularCustos: '{% url "estruturas:api_calcular_custos" %}',
            validarConfiguracao: '{% url "estruturas:api_validar_configuracao" %}',
            salvarConfiguracao: '{% url "estruturas:api_salvar_configuracao" %}',
            aplicarTemplate: '{% url "estruturas:api_aplicar_template" %}',
            generatePdf: '{% url "estruturas:api_gerar_pdf" %}'
        }
    };

    // Global helper functions
    let sidebarCollapsed = false;
    let mobileSidebarOpen = false;
    
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        sidebarCollapsed = !sidebarCollapsed;
        
        if (sidebarCollapsed) {
            sidebar.classList.add('collapsed');
        } else {
            sidebar.classList.remove('collapsed');
        }
    }
    
    function toggleMobileSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        mobileSidebarOpen = !mobileSidebarOpen;
        
        if (mobileSidebarOpen) {
            sidebar.classList.add('open');
            overlay.classList.add('active');
        } else {
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
        }
    }
    
    function clearSearch() {
        const searchInput = document.getElementById('search-structures');
        if (searchInput) {
            searchInput.value = '';
            searchInput.dispatchEvent(new Event('input'));
        }
    }

    function showLoading() {
        const loadingOverlay = document.getElementById('loading-overlay');
        if (loadingOverlay) {
            loadingOverlay.style.display = 'flex';
        }
    }

    function hideLoading() {
        const loadingOverlay = document.getElementById('loading-overlay');
        if (loadingOverlay) {
            loadingOverlay.style.display = 'none';
        }
    }
    
    // Global drag and drop handlers
    function allowDrop(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'copy';
        
        const canvasContainer = document.getElementById('canvas-container');
        if (canvasContainer) {
            canvasContainer.classList.add('drag-over');
        }
    }

    function handleDrop(e) {
        e.preventDefault();
        
        const canvasContainer = document.getElementById('canvas-container');
        if (canvasContainer) {
            canvasContainer.classList.remove('drag-over');
        }

        try {
            const structureData = JSON.parse(e.dataTransfer.getData('text/plain'));
            const rect = canvasContainer.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            if (window.siriusCanvas) {
                window.siriusCanvas.addElementToCanvas(structureData, { x, y });
            }
        } catch (error) {
            console.error('Error handling drop:', error);
        }
    }
    
    function handleDragLeave(e) {
        const canvasContainer = document.getElementById('canvas-container');
        if (canvasContainer && !canvasContainer.contains(e.relatedTarget)) {
            canvasContainer.classList.remove('drag-over');
        }
    }
    
    // Initialize canvas when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        if (window.djangoData && window.djangoData.apiUrls) {
            window.siriusCanvas = new SiriusCanvas();
        } else {
            console.error('Django data not available');
        }
    });
</script>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/canvas-clean.js' %}"></script>
{% endblock %}
